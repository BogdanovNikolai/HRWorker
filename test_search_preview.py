#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –ø–æ–∏—Å–∫–∞ —Å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–º –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º.
"""

import requests
import json
import time

def test_search_preview_flow():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π flow –ø–æ–∏—Å–∫–∞: –ø–æ–∏—Å–∫ -> –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä -> —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—é–º–µ"""
    
    base_url = "http://localhost:5000"
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ flow –ø–æ–∏—Å–∫–∞...")
    
    # –®–∞–≥ 1: –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
    print("\n1Ô∏è‚É£ –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫...")
    search_params = {
        "keywords[]": ["python developer"],
        "source": "hh",
        "region": ["2019"],  # –ú–æ—Å–∫–≤–∞
        "total": "5",
        "per_page": "5"
    }
    
    try:
        response = requests.get(f"{base_url}/search", params=search_params, allow_redirects=False)
        print(f"   –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: {response.status_code}")
        
        if response.status_code == 302:  # Redirect
            redirect_url = response.headers.get('Location')
            print(f"   –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞: {redirect_url}")
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º task_id –∏–∑ URL
            if "/search_preview/" in redirect_url:
                task_id = redirect_url.split("/search_preview/")[1].split("?")[0]
                print(f"   Task ID: {task_id}")
                
                # –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                print("\n2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞...")
                preview_response = requests.get(f"{base_url}/search_preview/{task_id}")
                print(f"   –°—Ç–∞—Ç—É—Å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞: {preview_response.status_code}")
                
                if preview_response.status_code == 200:
                    print("   ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–µ–∑—é–º–µ
                    if "–ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑—é–º–µ" in preview_response.text:
                        print("   ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ä–µ–∑—é–º–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è")
                    else:
                        print("   ‚ùå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ä–µ–∑—é–º–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–Ω–æ–ø–æ–∫
                    if "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—é–º–µ" in preview_response.text:
                        print("   ‚úÖ –ö–Ω–æ–ø–∫–∞ '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—é–º–µ' –Ω–∞–π–¥–µ–Ω–∞")
                    else:
                        print("   ‚ùå –ö–Ω–æ–ø–∫–∞ '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—é–º–µ' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
                        
                    if "–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫" in preview_response.text:
                        print("   ‚úÖ –ö–Ω–æ–ø–∫–∞ '–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫' –Ω–∞–π–¥–µ–Ω–∞")
                    else:
                        print("   ‚ùå –ö–Ω–æ–ø–∫–∞ '–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
                        
                    if "–ù–æ–≤—ã–π –ø–æ–∏—Å–∫" in preview_response.text:
                        print("   ‚úÖ –ö–Ω–æ–ø–∫–∞ '–ù–æ–≤—ã–π –ø–æ–∏—Å–∫' –Ω–∞–π–¥–µ–Ω–∞")
                    else:
                        print("   ‚ùå –ö–Ω–æ–ø–∫–∞ '–ù–æ–≤—ã–π –ø–æ–∏—Å–∫' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
                    
                    # –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ø–∏—Å–∫—É —Ä–µ–∑—é–º–µ
                    print("\n3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ø–∏—Å–∫—É —Ä–µ–∑—é–º–µ...")
                    resumes_response = requests.get(f"{base_url}/resumes/{task_id}")
                    print(f"   –°—Ç–∞—Ç—É—Å —Å–ø–∏—Å–∫–∞ —Ä–µ–∑—é–º–µ: {resumes_response.status_code}")
                    
                    if resumes_response.status_code == 200:
                        print("   ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–ø–∏—Å–∫–∞ —Ä–µ–∑—é–º–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
                    else:
                        print("   ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ä–µ–∑—é–º–µ")
                        
                else:
                    print(f"   ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞: {preview_response.status_code}")
                    
            else:
                print("   ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π URL –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è")
                
        else:
            print(f"   ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: {response.status_code}")
            
    except requests.exceptions.ConnectionError:
        print("   ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ.")
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞: {e}")

def test_search_with_no_results():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–∏—Å–∫ –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
    
    base_url = "http://localhost:5000"
    
    print("\nüß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...")
    
    # –ü–æ–∏—Å–∫ —Å –æ—á–µ–Ω—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º–∏ –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—Ä—è–¥ –ª–∏ –Ω–∞–π–¥—É—Ç —Ä–µ–∑—é–º–µ
    search_params = {
        "keywords[]": ["very_specific_keyword_that_should_not_exist_12345"],
        "source": "hh",
        "region": ["2019"],
        "total": "5",
        "per_page": "5"
    }
    
    try:
        response = requests.get(f"{base_url}/search", params=search_params, allow_redirects=False)
        
        if response.status_code == 302:
            redirect_url = response.headers.get('Location')
            task_id = redirect_url.split("/search_preview/")[1].split("?")[0]
            
            preview_response = requests.get(f"{base_url}/search_preview/{task_id}")
            
            if preview_response.status_code == 200:
                if "–†–µ–∑—é–º–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" in preview_response.text:
                    print("   ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ '–†–µ–∑—é–º–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã' –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
                else:
                    print("   ‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —Ä–µ–∑—é–º–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è")
                    
                if "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—é–º–µ" not in preview_response.text:
                    print("   ‚úÖ –ö–Ω–æ–ø–∫–∞ '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—é–º–µ' —Å–∫—Ä—ã—Ç–∞ –¥–ª—è –ø—É—Å—Ç—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
                else:
                    print("   ‚ùå –ö–Ω–æ–ø–∫–∞ '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—é–º–µ' –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è –ø—É—Å—Ç—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
                    
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    print("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –ø–æ–∏—Å–∫–∞")
    print("=" * 50)
    
    test_search_preview_flow()
    test_search_with_no_results()
    
    print("\n" + "=" * 50)
    print("üèÅ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ") 