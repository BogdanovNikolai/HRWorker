# Новый Flow Поиска с Предварительным Просмотром

## Обзор

Реализован новый flow поиска резюме, который предоставляет пользователю больше контроля над процессом поиска и лучший пользовательский опыт.

## Старый Flow

```
Input query → Resume list
```

## Новый Flow

```
Input query → Search Preview (показывает количество найденных резюме) → Resume list (если пользователь подтверждает)
```

## Детальное описание

### 1. Страница поиска (`/search`)
- Пользователь заполняет форму поиска с различными критериями
- При отправке формы выполняется поиск резюме
- Параметры поиска сохраняются в Redis для последующего использования
- Пользователь перенаправляется на страницу предварительного просмотра

### 2. Страница предварительного просмотра (`/search_preview/<task_id>`)
- Показывает количество найденных резюме
- Отображает основные параметры поиска:
  - Ключевые слова
  - Регион
  - Источник (HeadHunter/Avito)
  - Зарплата (если указана)
  - Опыт работы (если указан)
  - Количество запрошенных резюме

#### Кнопки действий:
- **"Просмотреть резюме"** - переход к списку найденных резюме
- **"Изменить поиск"** - возврат к форме поиска с заполненными параметрами
- **"Новый поиск"** - переход к пустой форме поиска

#### Особенности:
- Если резюме не найдены, кнопка "Просмотреть резюме" скрывается
- Отображается соответствующее сообщение о результатах поиска
- Предоставляются советы по улучшению поиска

### 3. Страница списка резюме (`/resumes/<task_id>`)
- Отображает найденные резюме в привычном формате
- Все существующие функции (экспорт, фильтрация и т.д.) работают как прежде

## Техническая реализация

### Новые файлы:
- `templates/search_preview.html` - шаблон страницы предварительного просмотра
- `test_search_preview.py` - тесты для проверки нового функционала

### Изменения в существующих файлах:
- `app.py`:
  - Добавлен новый роут `/search_preview/<task_id>`
  - Изменен роут `/search` для перенаправления на preview
  - Добавлено сохранение параметров поиска в Redis

### Сохранение параметров поиска:
- Параметры поиска сохраняются в Redis с ключом `search_params:{task_id}`
- TTL: 1 час
- Используется для отображения информации на странице предварительного просмотра
- При нажатии "Изменить поиск" все параметры корректно передаются обратно в форму поиска
- Поддерживаются все типы параметров: одиночные значения, массивы, множественные выборы

## Преимущества нового flow

1. **Лучший UX**: Пользователь видит результаты поиска до загрузки полного списка
2. **Экономия ресурсов**: Можно скорректировать поиск без повторной загрузки данных
3. **Прозрачность**: Пользователь понимает, сколько резюме найдено
4. **Гибкость**: Возможность изменить параметры поиска или начать новый поиск
5. **Обратная совместимость**: Все существующие функции продолжают работать

## Тестирование

Для проверки нового функционала запустите:

```bash
python test_search_preview.py
```

Тест проверяет:
- Корректность перенаправления на страницу предварительного просмотра
- Отображение информации о количестве найденных резюме
- Наличие всех необходимых кнопок
- Работу с пустыми результатами поиска
- Переход к списку резюме

## Обработка параметров поиска

### Передача параметров обратно в форму
При нажатии кнопки "Изменить поиск" система:

1. **Извлекает сохраненные параметры** из Redis
2. **Формирует корректный URL** с параметрами запроса
3. **Перенаправляет пользователя** на форму поиска с заполненными полями

### Поддерживаемые типы параметров:
- **Одиночные значения**: `source`, `total`, `per_page`, `salary_from`, `salary_to`
- **Массивы**: `keywords[]`, `region`, `experience`, `education_levels`
- **Множественные выборы**: `employment`, `schedule`, `job_search_status`
- **Чекбоксы**: `label` (only_with_salary, only_with_photo, etc.)
- **Текстовые поля**: `description`
- **Даты**: `date_from`, `date_to`

### Тестирование параметров
Для проверки корректности передачи параметров запустите:

```bash
python test_search_params.py
```

Этот тест проверяет:
- Сохранение всех типов параметров
- Корректную передачу в URL
- Отображение в форме поиска

## Миграция

Новый flow полностью обратно совместим. Существующие ссылки на `/resumes/<task_id>` продолжают работать, но новые поиски теперь проходят через предварительный просмотр. 